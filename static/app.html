<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Issue Tracer — Search</title>
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <script src="assets/tailwind.js"></script>
  <script src="assets/marked.min.js"></script>
  <script src="assets/purify.min.js"></script>
  <link href="assets/dm-sans.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Arad';
      src: url('/assets/Arad-2.0.0/Arad.woff2') format('woff2'),
           url('/assets/Arad-2.0.0/Arad.woff') format('woff'),
           url('/assets/Arad-2.0.0/Arad-Regular.woff2') format('woff2'),
           url('/assets/Arad-2.0.0/Arad-Regular.woff') format('woff'),
           url('/assets/Arad-2.0.0/Arad.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    body { font-family: 'DM Sans', system-ui, sans-serif; }
    .message-body { white-space: pre-wrap; word-break: break-word; }
    .ai-modal-backdrop { background: rgba(0,0,0,0.6); }
    .ai-modal-content pre { white-space: pre-wrap; word-break: break-word; }
    .ai-modal-content.rtl {
      direction: rtl;
      text-align: right;
      font-family: 'Arad', 'Tahoma', 'Segoe UI', sans-serif;
    }
    .ai-modal-content.rtl p,
    .ai-modal-content.rtl .font-mono {
      font-family: inherit;
    }
    .ai-modal-content.rtl blockquote {
      border-left: none;
      border-right: 3px solid #64748b;
      padding-left: 0;
      padding-right: 1rem;
    }
    .ai-modal-content.rtl ul { margin-right: 1.25rem; margin-left: 0; padding-right: 1.25rem; padding-left: 0; }
    .ai-modal-content code { font-family: ui-monospace, monospace; font-size: 0.875em; }
    .ai-modal-content h2 { font-size: 1.125rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #e2e8f0; }
    .ai-modal-content h2:first-child { margin-top: 0; }
    .ai-modal-content h3 { font-size: 1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.375rem; color: #cbd5e1; }
    .ai-modal-content h4 { font-size: 0.9375rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #94a3b8; }
    .ai-modal-content p { margin-bottom: 0.75rem; }
    .ai-modal-content ul { margin: 0.5rem 0 0.75rem 1.25rem; padding-left: 0; list-style-type: disc; }
    .ai-modal-content li { margin-bottom: 0.25rem; }
    .ai-modal-content li p { margin-bottom: 0.25rem; }
    .ai-modal-content blockquote { margin: 0.75rem 0; padding: 0.5rem 0 0.5rem 1rem; border-left: 3px solid #64748b; color: #94a3b8; }
    .ai-modal-content blockquote p { margin-bottom: 0.25rem; }
    .ai-modal-content .pre-wrapper { position: relative; margin: 0.75rem 0; }
    .ai-modal-content .pre-wrapper pre { margin: 0; padding: 0.75rem 1rem 2.25rem 1rem; border-radius: 0.5rem; background: #1e293b; border: 1px solid #475569; overflow-x: auto; font-size: 0.8125rem; }
    .ai-modal-content .pre-wrapper .pre-copy-btn { position: absolute; top: 0.375rem; right: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.6875rem; border-radius: 0.25rem; background: #334155; color: #94a3b8; border: 1px solid #475569; cursor: pointer; }
    .ai-modal-content .pre-wrapper .pre-copy-btn:hover { background: #475569; color: #e2e8f0; }
    .ai-modal-content pre code { padding: 0; background: transparent; }
    .ai-modal-content :not(pre) > code { padding: 0.125rem 0.375rem; border-radius: 0.25rem; background: #334155; color: #e2e8f0; }
    .ai-modal-content hr { margin: 1rem 0; border: none; border-top: 1px solid #475569; }
    .ai-modal-content strong { font-weight: 600; color: #f1f5f9; }
    #scrollToTop {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 2.75rem;
      height: 2.75rem;
      border-radius: 0.5rem;
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(71, 85, 105, 0.6);
      color: #f59e0b;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transform: translateY(0.5rem);
      transition: opacity 0.2s, visibility 0.2s, transform 0.2s, background 0.15s;
      z-index: 50;
    }
    #scrollToTop.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    #scrollToTop:hover {
      background: rgba(245, 158, 11, 0.2);
      border-color: rgba(245, 158, 11, 0.5);
    }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 font-sans">
  <header class="border-b border-slate-800 bg-slate-900/50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/app" class="text-lg font-semibold text-slate-100">Issue Tracer</a>
        <span class="text-slate-500 text-sm"></span>
      </div>
      <div class="flex items-center gap-4">
        <form action="/admin" method="get" class="inline">
          <button type="submit" class="text-sm text-slate-400 hover:text-slate-200">Admin Panel</button>
        </form>
        <form action="/api/logout" method="post" class="inline">
          <button type="submit" class="text-sm text-slate-400 hover:text-slate-200">Log out</button>
        </form>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-5 mb-6">
      <h2 class="text-sm font-medium text-slate-400 uppercase tracking-wider mb-4">Time range (Asia/Tehran)</h2>
      <form id="searchForm" class="flex flex-wrap items-end gap-4">
        <div>
          <label for="start_date" class="block text-xs text-slate-500 mb-1">Start date</label>
          <input type="date" id="start_date" name="start_date" required
            class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500" />
        </div>
        <div>
          <label for="start_time" class="block text-xs text-slate-500 mb-1">Start time</label>
          <input type="text" id="start_time" name="start_time" required placeholder="19:40:00"
            class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 w-28" />
        </div>
        <div>
          <label for="end_date" class="block text-xs text-slate-500 mb-1">End date</label>
          <input type="date" id="end_date" name="end_date" required
            class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500" />
        </div>
        <div>
          <label for="end_time" class="block text-xs text-slate-500 mb-1">End time</label>
          <input type="text" id="end_time" name="end_time" required placeholder="19:50:00"
            class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 w-28" />
        </div>
        <div class="flex items-center gap-2">
          <button type="submit" id="searchBtn"
            class="px-4 py-2 rounded-lg bg-amber-500 text-slate-900 font-medium hover:bg-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-slate-900 transition">
            Search
          </button>
        </div>
      </form>
      <p id="formError" class="mt-3 text-sm text-red-400 hidden"></p>
    </section>

    <div id="progressSection" class="hidden mb-6">
      <div class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-5">
        <p class="text-slate-300 mb-2">Searching Graylog…</p>
        <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full bg-amber-500 rounded-full animate-pulse" style="width: 100%"></div>
        </div>
      </div>
    </div>

    <div id="aiModal" class="fixed inset-0 z-50 hidden ai-modal-backdrop items-center justify-center p-4" aria-modal="true" role="dialog" aria-labelledby="aiModalTitle">
      <div class="bg-slate-900 border border-slate-600 rounded-xl shadow-xl max-w-2xl w-full max-h-[85vh] flex flex-col">
        <div class="flex items-center justify-between px-5 py-3 border-b border-slate-700">
          <div>
            <h2 id="aiModalTitle" class="text-lg font-medium text-slate-200" style="margin-left: 2px;">AI Analysis</h2>
            <span class="flex items-center gap-2">
              <img src="assets/ai.svg" alt="AI Logo" class="w-4 h-4 opacity-90" style="filter: brightness(0) invert(1);"/>
              <span class="text-xs text-slate-500 mt-0.5 ml-0.5" style="font-size: 11px;">Powered by GPT 5.2</span>
            </span>
            
          </div>
          <button type="button" id="aiModalClose" class="p-1 rounded text-slate-400 hover:text-slate-200 hover:bg-slate-700 transition" aria-label="Close">&times;</button>
        </div>
        <div id="aiModalBody" class="ai-modal-content px-5 py-4 overflow-y-auto flex-1 text-slate-300 text-sm leading-relaxed"></div>
      </div>
    </div>

    <div id="resultsWrapper" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-medium text-slate-200">Results</h2>
        <button type="button" id="downloadJsonBtn" class="px-3 py-1.5 rounded-lg bg-slate-700 text-slate-200 text-sm hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition">
          Download JSON
        </button>
      </div>
      <div id="resultsSection" class="space-y-8"></div>
    </div>
  </main>

  <button type="button" id="scrollToTop" title="Scroll to top" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
  </button>

  <script>
    const searchForm = document.getElementById('searchForm');
    const searchBtn = document.getElementById('searchBtn');
    const formError = document.getElementById('formError');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const resultsWrapper = document.getElementById('resultsWrapper');
    const resultsSection = document.getElementById('resultsSection');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');

    let lastResultData = null;
    const aiResultCache = new Map();

    let highlightErrorWords = ['error', 'fail', 'unknown', 'not', 'err', 'exception', 'eof', 'crash', 'fatal', 'unexpected'];
    let highlightWarningWords = ['warning'];
    let highlightSpecialWords = [];
    let highlightSuccessWords = [];

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        start_date: params.get('start_date') || '',
        start_time: params.get('start_time') || '',
        end_date: params.get('end_date') || '',
        end_time: params.get('end_time') || '',
      };
    }

    function setUrlParams(params) {
      const search = new URLSearchParams(params).toString();
      const url = search ? '/app?' + search : '/app';
      window.history.replaceState({}, '', url);
    }

    function parseDateTime(dateStr, timeStr) {
      if (!dateStr || !timeStr) return null;
      const combined = dateStr.trim() + ' ' + timeStr.trim();
      const withSeconds = /^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}$/.test(combined) ? combined + ':00' : combined;
      const d = new Date(withSeconds);
      return isNaN(d.getTime()) ? null : d;
    }

    function applyParamsToForm(params) {
      if (params.start_date) document.getElementById('start_date').value = params.start_date;
      if (params.start_time) document.getElementById('start_time').value = params.start_time;
      if (params.end_date) document.getElementById('end_date').value = params.end_date;
      if (params.end_time) document.getElementById('end_time').value = params.end_time;
    }

    async function loadDefaults() {
      const params = getUrlParams();
      if (params.start_date && params.start_time && params.end_date && params.end_time) {
        applyParamsToForm(params);
      }
      try {
        const res = await fetch('/api/defaults');
        if (!res.ok) return;
        const defaults = await res.json();
        applyParamsToForm({
          start_date: params.start_date || defaults.start_date,
          start_time: params.start_time || defaults.start_time,
          end_date: params.end_date || defaults.end_date,
          end_time: params.end_time || defaults.end_time,
        });
        if (Array.isArray(defaults.highlight_error_words)) highlightErrorWords = defaults.highlight_error_words;
        if (Array.isArray(defaults.highlight_warning_words)) highlightWarningWords = defaults.highlight_warning_words;
        if (Array.isArray(defaults.highlight_special_words)) highlightSpecialWords = defaults.highlight_special_words;
        if (Array.isArray(defaults.highlight_success_words)) highlightSuccessWords = defaults.highlight_success_words;
      } catch (_) {}
    }

    function messageToCopyText(msg) {
      const lines = [];
      for (const [k, v] of Object.entries(msg)) {
        if (v == null) continue;
        lines.push(k + ': ' + (typeof v === 'string' ? v : JSON.stringify(v)));
      }
      return lines.join('\n');
    }

    function copyToClipboard(text) {
      return navigator.clipboard.writeText(text);
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function escapeRegex(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightMessageText(text) {
      if (!text) return '';
      let out = escapeHtml(text);
      const wrap = (words, color) => {
        if (!words.length) return;
        const pattern = words.map(escapeRegex).join('|');
        const re = new RegExp('(' + pattern + ')', 'gi');
        out = out.replace(re, '<span style="color:' + color + '; font-weight: 700">$1</span>');
      };
      wrap(highlightErrorWords, '#f87171');
      wrap(highlightWarningWords, '#facc15');
      wrap(highlightSpecialWords, '#a855f7');
      wrap(highlightSuccessWords, '#a855f7');
      return out;
    }

    function renderMessageCard(msg) {
      const copyText = messageToCopyText(msg);
      const section = (msg._section || '').toLowerCase();
      let displayMessage = (msg.message != null ? String(msg.message) : '') +
        (msg.data_trace ? '\n' + msg.data_trace : '') +
        (msg.data_message_exception ? '\n' + msg.data_message_exception : '');
      if (section === 'backend_mobapi') {
        if (msg.data_url_method != null && msg.data_url_method !== '') displayMessage += '\ndata_url_method: ' + msg.data_url_method;
        if (msg.data_url_uri != null && msg.data_url_uri !== '') displayMessage += '\ndata_url_uri: ' + msg.data_url_uri;
      }
      if (section === 'frontend_nextjs' || section === 'frontend_nextjs_pods') {
        if (msg.response_status != null && msg.response_status !== '') displayMessage += '\nresponse_status: ' + msg.response_status;
      }
      const timestamp = msg.timestamp || '';
      const div = document.createElement('div');
      div.className = 'bg-slate-800/80 border border-slate-600/60 rounded-lg p-4 group relative';
      div.innerHTML =
        '<div class="flex items-start justify-between gap-2 mb-2">' +
          '<span class="text-xs text-slate-500 font-mono">' + escapeHtml(timestamp) + '</span>' +
          '<div class="flex gap-1.5 shrink-0">' +
            '<button type="button" class="copy-btn px-2 py-1 text-xs rounded bg-slate-700 text-slate-300 hover:bg-amber-500 hover:text-slate-900 transition">Copy</button>' +
            '<button type="button" class="ask-ai-btn px-2 py-1 text-xs rounded bg-slate-700 text-slate-300 hover:bg-violet-500 hover:text-white transition" title="AI Analysis">AI Analysis</button>' +
          '</div>' +
        '</div>' +
        '<div class="message-body text-sm text-slate-300 font-mono">' + highlightMessageText(displayMessage || '(no message)') + '</div>';
      const copyBtn = div.querySelector('.copy-btn');
      copyBtn.addEventListener('click', async () => {
        try {
          await copyToClipboard(copyText);
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        } catch (_) {
          copyBtn.textContent = 'Failed';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        }
      });
      const askAiBtn = div.querySelector('.ask-ai-btn');
      const resultKey = makeAiResultKey(msg.timestamp, msg._query);
      askAiBtn.addEventListener('click', () => openAskAiModal(copyText, askAiBtn, resultKey));
      return div;
    }

    function makeAiResultKey(timestamp, _query) {
      const s = (timestamp || '') + (_query || '');
      try {
        const bytes = new TextEncoder().encode(s);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      } catch (_) {
        return '';
      }
    }

    function hasPersian(text) {
      if (!text || typeof text !== 'string') return false;
      return /[\u0600-\u06FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(text);
    }

    function applyAiBodyDirection(bodyEl, content) {
      if (!bodyEl) return;
      if (hasPersian(content)) {
        bodyEl.classList.add('rtl');
        bodyEl.setAttribute('dir', 'rtl');
      } else {
        bodyEl.classList.remove('rtl');
        bodyEl.removeAttribute('dir');
      }
    }

    function formatAiContent(text) {
      if (!text) return '';
      if (typeof marked === 'undefined') {
        return '<p class="whitespace-pre-wrap">' + escapeHtml(text).replace(/\n/g, '<br>') + '</p>';
      }
      marked.setOptions({ breaks: true, gfm: true });
      const rawHtml = marked.parse(text);
      if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(rawHtml, {
          ALLOWED_TAGS: ['p', 'br', 'h2', 'h3', 'h4', 'ul', 'ol', 'li', 'strong', 'em', 'code', 'pre', 'blockquote', 'hr', 'a'],
          ALLOWED_ATTR: ['href', 'target', 'rel'],
        });
      }
      return rawHtml;
    }

    function attachCodeCopyButtons(container) {
      if (!container) return;
      const pres = container.querySelectorAll('pre');
      pres.forEach((pre) => {
        if (pre.closest('.pre-wrapper')) return;
        const wrapper = document.createElement('div');
        wrapper.className = 'pre-wrapper';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pre-copy-btn';
        btn.textContent = 'Copy';
        btn.setAttribute('aria-label', 'Copy code');
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);
        wrapper.appendChild(btn);
        btn.addEventListener('click', async () => {
          const text = (pre.querySelector('code') || pre).textContent || '';
          try {
            await copyToClipboard(text);
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
          } catch (_) {
            btn.textContent = 'Failed';
            setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
          }
        });
      });
    }

    async function streamAskAi(bodyPayload, bodyEl, showResult, showError, done, cacheKey) {
      try {
        const resp = await fetch('/api/ask-ai-stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyPayload),
        });
        if (!resp.ok) {
          showError('Request failed: ' + resp.status);
          done();
          return;
        }
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';
        let lastRender = 0;
        const renderThrottleMs = 80;
        function renderStream() {
          bodyEl.innerHTML = fullContent ? formatAiContent(fullContent) : '<p class="text-slate-300 text-sm"></p>';
          applyAiBodyDirection(bodyEl, fullContent);
          bodyEl.scrollTop = bodyEl.scrollHeight;
        }
        bodyEl.innerHTML = '<p class="text-slate-300 text-sm"></p>';
        applyAiBodyDirection(bodyEl, '');
        while (true) {
          const { value, done: readerDone } = await reader.read();
          if (readerDone) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split('\n\n');
          buffer = parts.pop() || '';
          for (const part of parts) {
            const line = part.trim();
            if (!line.startsWith('data: ')) continue;
            try {
              const data = JSON.parse(line.slice(6));
              if (data.error) {
                showError(data.error);
                done();
                return;
              }
              if (data.content) {
                fullContent += data.content;
                const now = Date.now();
                if (now - lastRender >= renderThrottleMs) {
                  lastRender = now;
                  renderStream();
                }
              }
              if (data.done) {
                showResult(fullContent);
                aiResultCache.set(cacheKey, fullContent);
                done();
                return;
              }
            } catch (_) {}
          }
        }
        for (const part of buffer.split('\n\n')) {
          const line = part.trim();
          if (!line.startsWith('data: ')) continue;
          try {
            const data = JSON.parse(line.slice(6));
            if (data.content) fullContent += data.content;
            if (data.done && fullContent) {
              showResult(fullContent);
              aiResultCache.set(cacheKey, fullContent);
              done();
              return;
            }
          } catch (_) {}
        }
        renderStream();
        if (fullContent) {
          showResult(fullContent);
          aiResultCache.set(cacheKey, fullContent);
        }
      } catch (err) {
        showError(String(err.message || err));
      }
      done();
    }

    function openAskAiModal(messageContent, triggerBtn, resultKey) {
      const modal = document.getElementById('aiModal');
      const body = document.getElementById('aiModalBody');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      const cacheKey = resultKey || messageContent;
      const cached = aiResultCache.get(cacheKey);
      if (cached != null) {
        body.innerHTML = formatAiContent(cached);
        attachCodeCopyButtons(body);
        applyAiBodyDirection(body, cached);
        return;
      }

      function showResult(content) {
        body.innerHTML = formatAiContent(content);
        attachCodeCopyButtons(body);
        applyAiBodyDirection(body, content);
        aiResultCache.set(cacheKey, content);
      }

      function showError(msg) {
        body.classList.remove('rtl');
        body.removeAttribute('dir');
        body.innerHTML = '<p class="text-red-400">' + escapeHtml(msg) + '</p>';
      }

      function done() {
        if (triggerBtn) {
          triggerBtn.disabled = false;
          triggerBtn.textContent = 'AI Analysis';
        }
      }

      if (resultKey) {
        fetch('/api/ai-result?key=' + encodeURIComponent(resultKey))
          .then((r) => r.json())
          .then((data) => {
            if (data.ok && data.content) {
              showResult(data.content);
              done();
              return;
            }
            throw null;
          })
          .catch(() => {
            body.classList.remove('rtl');
            body.removeAttribute('dir');
            body.innerHTML = '<p class="text-slate-400">Analyzing with AI…</p>';
            if (triggerBtn) {
              triggerBtn.disabled = true;
              triggerBtn.textContent = '…';
            }
            streamAskAi(
              { content: messageContent, key: resultKey },
              body,
              showResult,
              showError,
              done,
              cacheKey
            );
          });
        return;
      }

      body.classList.remove('rtl');
      body.removeAttribute('dir');
      body.innerHTML = '<p class="text-slate-400">Analyzing with AI…</p>';
      if (triggerBtn) {
        triggerBtn.disabled = true;
        triggerBtn.textContent = '…';
      }
      streamAskAi(
        { content: messageContent },
        body,
        showResult,
        showError,
        done,
        cacheKey
      );
    }

    function closeAiModal() {
      const modal = document.getElementById('aiModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('aiModalClose').addEventListener('click', closeAiModal);
    document.getElementById('aiModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeAiModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAiModal(); });

    function renderSection(title, messages) {
      const section = document.createElement('div');
      section.className = 'rounded-xl border border-slate-700/60 bg-slate-900/40 overflow-hidden';
      const header = document.createElement('div');
      header.className = 'px-5 py-3 border-b border-slate-700/60 bg-slate-800/40';
      header.innerHTML = '<h3 class="text-lg font-medium text-slate-200">' + escapeHtml(title) + '</h3>' +
        '<p class="text-slate-500 text-xs mt-0.5">' + (messages ? messages.length : 0) + ' message(s)</p>';
      section.appendChild(header);
      const content = document.createElement('div');
      content.className = 'p-4 space-y-3';
      if (messages && messages.length > 0) {
        messages.forEach((m) => content.appendChild(renderMessageCard(m)));
      } else {
        content.innerHTML = '<p class="text-slate-500 text-sm">No messages</p>';
      }
      section.appendChild(content);
      return section;
    }

    function defaultResultFilename(data) {
      const interval = data?.interval || {};
      const from = (interval.from_asia_tehran || '').replace(/[:.]/g, '-').slice(0, 19);
      const to = (interval.to_asia_tehran || '').replace(/[:.]/g, '-').slice(0, 19);
      if (from && to) return 'graylog-result-' + from + '--' + to + '.json';
      return 'graylog-result-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';
    }

    function downloadResultJson() {
      if (!lastResultData) return;
      const json = JSON.stringify(lastResultData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = defaultResultFilename(lastResultData);
      a.click();
      URL.revokeObjectURL(url);
    }

    function renderResults(data) {
      lastResultData = data;
      const sections = data.sections || {};
      const backendMessages = sections.backend_mobapi?.messages || [];
      const frontendNext = sections.frontend_nextjs?.messages || [];
      const frontendPods = sections.frontend_nextjs_pods?.messages || [];
      const frontendMessages = [...frontendNext, ...frontendPods];

      resultsSection.innerHTML = '';
      resultsSection.appendChild(renderSection('Backend', backendMessages));
      resultsSection.appendChild(renderSection('Frontend', frontendMessages));
      resultsWrapper.classList.remove('hidden');
    }

    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.classList.add('hidden');
      const startDate = document.getElementById('start_date').value.trim();
      const startTime = document.getElementById('start_time').value.trim();
      const endDate = document.getElementById('end_date').value.trim();
      const endTime = document.getElementById('end_time').value.trim();

      const fromDt = parseDateTime(startDate, startTime);
      const toDt = parseDateTime(endDate, endTime);
      if (!fromDt) {
        formError.textContent = 'Invalid start date/time. Use YYYY-MM-DD and HH:MM or HH:MM:SS.';
        formError.classList.remove('hidden');
        return;
      }
      if (!toDt) {
        formError.textContent = 'Invalid end date/time. Use YYYY-MM-DD and HH:MM or HH:MM:SS.';
        formError.classList.remove('hidden');
        return;
      }
      if (fromDt >= toDt) {
        formError.textContent = 'Start must be before end.';
        formError.classList.remove('hidden');
        return;
      }

      searchBtn.disabled = true;
      progressSection.classList.remove('hidden');
      resultsWrapper.classList.add('hidden');

      try {
        const res = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start_date: startDate,
            start_time: startTime,
            end_date: endDate,
            end_time: endTime,
          }),
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok) {
          formError.textContent = body.error || 'Search failed';
          formError.classList.remove('hidden');
          return;
        }
        if (body.ok && body.data) {
          setUrlParams({
            start_date: startDate,
            start_time: startTime,
            end_date: endDate,
            end_time: endTime,
          });
          renderResults(body.data);
        }
      } finally {
        progressSection.classList.add('hidden');
        searchBtn.disabled = false;
      }
    });

    downloadJsonBtn.addEventListener('click', downloadResultJson);

    loadDefaults();

    (function () {
      const scrollToTopBtn = document.getElementById('scrollToTop');
      const scrollThreshold = 200;

      function toggleScrollToTop() {
        if (window.scrollY > scrollThreshold) {
          scrollToTopBtn.classList.add('visible');
        } else {
          scrollToTopBtn.classList.remove('visible');
        }
      }

      window.addEventListener('scroll', toggleScrollToTop, { passive: true });
      toggleScrollToTop();

      scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    })();
  </script>
</body>
</html>
